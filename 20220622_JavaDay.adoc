= 2022/06/22 - JavaDay au Paris JUG: Le futur de Java en 2022
Thomas SCHWENDER <icon:github[] https://github.com/Ardemius/[GitHub] / icon:twitter[role="aqua"] https://twitter.com/thomasschwender[@thomasschwender]>
// Handling GitHub admonition blocks icons
ifndef::env-github[:icons: font]
ifdef::env-github[]
:status:
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]
:imagesdir: ./images
:source-highlighter: highlightjs
:highlightjs-languages: asciidoc
// We must enable experimental attribute to display Keyboard, button, and menu macros
:experimental:
// Next 2 ones are to handle line breaks in some particular elements (list, footnotes, etc.)
:lb: pass:[<br> +]
:sb: pass:[<br>]
// check https://github.com/Ardemius/personal-wiki/wiki/AsciiDoctor-tips for tips on table of content in GitHub
:toc: macro
:toclevels: 4
// To number the sections of the table of contents
//:sectnums:
// Add an anchor with hyperlink before the section title
:sectanchors:
// To turn off figure caption labels and numbers
:figure-caption!:
// Same for examples
//:example-caption!:
// To turn off ALL captions
// :caption:

toc::[]

* JavaDay organis√© par le Paris JUG, au centre des congr√®s du Jardin d'Acclimatation, le 22/06/2022
* Description de l'√©v√®nement : https://javaday.parisjug.org/

== 09h15	: Accueil des participants

image:20220622_JavaDay_00.jpg[]

== 10h00 : Java en 2022 : profiter de Java 17

Talk donn√© par Jean-Michel Doudoux

.Abstract
----
Beaucoup d‚Äôapplications utilisent encore Java 8 mais Java a beaucoup √©volu√© depuis notamment avec la diffusion de deux versions LTS.

L‚Äôobjectif de cette pr√©sentation est de revenir sur certaines de ces nombreuses √©volutions de Java, notamment r√©centes afin d‚Äôen profiter dans nos applications. Au-del√† des √©volutions syntaxiques et dans les API, ce sera aussi l‚Äôoccasion de justifier la migration vers des versions plus r√©centes de Java.
----

=== Le pass√©

On commence par des rappels sur les grandes fonctionnalit√©s des pr√©c√©dentes versions de Java depuis Java 8

    * Java 8
    * Java 9
        ** JShell
        ** VarHandle
        ** *Et les fameux modules* : une fonctionnalit√© impactante et tr√®s controvers√©ee
            *** et dont la mise en oeuvre implique des contraintes (visibilit√©, accessibilit√©, organisation du code, ...)
        ** cr√©ation d'un JRE personnalit√© avec JLink
        ** `var` pour faciliter la d√©finition de variables
    * Java 10
        ** bien meilleur support des containers
    * Java 11
        ** version LTS
    * Java 14
        ** refonte des switch expression
            *** le switch devient une vraie expression. +
            On peut donc faire `String libelle = switch...` +
            image:20220622_JavaDay_01.jpg[]
    * Java 15
        ** blocs de texte
            *** exprimer une cha√Æne de caract√®res litt√©rale multiligne
        ** Helpful NullPointerException
    * Java 16
        ** pattern matching pour instanceof
        ** nouveau type de classe, les *records*
            *** son but est d'encapsuler des variables de fa√ßon immuable
    * Java 17
        ** les classes scell√©es (`sealed` classes) +
        image:20220622_JavaDay_02.jpg[]
        ** nouvelle version LTS
        ** diffus√©e en septembre 2021
        ** changement de licence d'Oracle (qui remet un peu de gratuit√© dedans)
    * Java 18
        ** diffus√©e en mars 2022
        ** UTF-8 par d√©faut (enfin !), sauf pour la sortie console
        ** le m√©canisme finalize est d√©pr√©ci√©

=== Le pr√©sent

Comment "vendre" √† la PROD (les OPS) la migration √† une version r√©cente de Java ? +
-> les bons arguments : *performance* et *s√©curit√©*

.Performance
image:20220622_JavaDay_03.jpg[]

.S√©curit√©
image:20220622_JavaDay_04.jpg[]

Comment "vendre" au management cette fois ? +
-> Les *co√ªts*, et d'autres arguments (dont le RGPD)

.Les autres arguments
image:20220622_JavaDay_05.jpg[]

*R√®gles g√©n√©rales de migration > 8*

    * mettre √† jour les outils
    * mettre √† jour les d√©pendances
    * utiliser jdeps
    * mythe urbain : aucune obligation de modulariser l'application

-> A partir de Java 11 toute version de Java retire des choses

    * `jdeprscan` pour obtenir les API d√©pr√©ci√©es du JDK
    * Jetez un oeil √† l'*almanac Java* pour vous aider

.migration de Java 8 vers Java 11
image:20220622_JavaDay_06.jpg[]

migration de Java 11 vers Java 17 : 

    * Il est important d'avoir un coverage √† 100% du code. +
    Pourquoi ? A cause de la nouvelle encapsulation forte des API internes du JDK +
    image:20220622_JavaDay_07.jpg[]

migration de Java 8 √† 17

=== Le futur

.Les projets futurs de Java
image:20220622_JavaDay_08.jpg[]

* pattern matching pour les switch (en preview d√®s Java 17)

.Et le futur un tout petit peu plus √©loign√©
image:20220622_JavaDay_09.jpg[]

-> Conclusion : Dans tous les cas, pour profiter de ces nouvelles fonctionnalit√©s, il *FAUT* migrer !

-> Ce talk est tr√®s proche de celui donn√© par Jean-Michel au dernier Devoxx France 2022 ("10 ans de Devoxx France et de Java"), et dont les slides sont disponibles ici : +
https://fr.slideshare.net/jmdoudoux/devoxx-2022-10-ans-de-devoxx-fr-et-de-javapdf

[NOTE]
====
Pour f√™ter les 4000 pages de "D√©veloppons en Java", le JavaDay offre 4 millefeuilles √† JM üòÅ 

image:20220622_JavaDay_10.jpg[]
====

== 10h50 : Rem√®des aux oomkill, warm-ups, et lenteurs pour des conteneurs JVM

Talk donn√© par Jean-Philippe Bempel et Brice Dutheil

-> Ce talk a √©t√© donn√© au dernier Devoxx France 2022 +
Il a trait √† tous les probl√®mes (oomkill) que l'on peut rencontrer quand l'on fait tourner Java dans un container (Kubernetes).

Mes notes de l'√©poque sont disponibles ici : +
https://github.com/Ardemius/meetups-talks-conferences-notes/tree/master/202204-devoxx-france#09h30-12h30-242ab-rem%C3%A8des-aux-oomkill-warm-ups-et-lenteurs-pour-des-conteneurs-jvm

=== Partie m√©moire et oomkill

.Rappel sur le RSS, le Resident Set Size
[NOTE]
====
La *Resident Set Size* (*RSS*, "taille du jeu r√©sident") est la quantit√© de m√©moire occup√©e par un processus contenue dans la RAM. +
RSS permet d‚Äôobtenir la taille r√©elle du conteneur Kubernetes.
====

.De quoi est compos√©e la m√©moire d'une JVM ?
image:20220622_JavaDay_11.jpg[]

* Pour le *monitoring*, il existe une multitudes de *MBeans* (accessible via *JMX*) +
Gr√¢ce √† cela on aura des infos sur quelques zones m√©moires, mais PAS toutes

* Il va falloir utiliser des outils de diagnostic, comme le fantastique *jcmd* +
image:20220622_JavaDay_12.jpg[]

    ** `jcmd $(pidof java) VM.native_memory` +
    image:20220622_JavaDay_13.jpg[]

.Il est important de donner au container plus de RAM que la valeur max de la heap
image:20220622_JavaDay_14.jpg[]

=== Autres probl√®mes

* red√©marrage du container

* Le JIT et les *compilateurs C1 et C2* :
    ** The JDK implementation by Oracle is based on the open-source OpenJDK project, which includes the HotSpot virtual machine.
    ** It contains 2 conventional JIT-compilers: the client compiler, also called C1 and the server compiler, called opto or C2.

* Avec Kubernetes, plus qu'une notion de CPU, on a une notion de *shares* et *quotas* +
image:20220622_JavaDay_15.jpg[]
image:20220622_JavaDay_16.jpg[]

* *Tuning CPU* : toujours un trade-off entre startup time vs request time
    ** adjust CPU shares  CPU quotas
    ** adjust liveness timeout
    ** use readiness / startup probes

.En conclusion, que faire quant √† la m√©moire et au d√©marrage
image:20220622_JavaDay_17.jpg[]
image:20220622_JavaDay_18.jpg[]

* Le conseil final de JP : TOUJOURS setter la heap (TOUJOURS) 
* Et attention au *RAMPercentage* qui n'est PAS un silver bullet pour r√©soudre tous les probl√®mes (loin de l√†)

-> Un talk qui rentre vraiment dans le d√©tail du domaine de la performance. +
A utiliser si vous √™tes confront√©s aux probl√®mes d√©crits (ou pour culture g√©n√©rale et savoir que des solutions existent). Peut para√Ætre un rien "abrupte" de prime abord üòâ 

TIP: Je conseille de vous r√©f√©rer au talk donn√© √† Devoxx si vous voulez plus de d√©tails, car il s'agissait d'une universit√© de 3h üòâ 

== 11h40 : S√©curit√© en Java 17 : les nouveaut√©s pass√©es et √† venir

Talk donn√© par Charles Sabourdin

* Initialement la JVM servait √† faire tourner du code qu'on ne connaissait pas sur le navigateur
* DONC la JVM est arriv√© avec son propre syst√®me de s√©curisation pour l'isoler du syst√®me

.Java Security Model
image:20220622_JavaDay_19.jpg[]

* Autre info √† savoir : pour des *raisons l√©gales*, certaines *fonctionnalit√©s sont volontairement limit√©es*, car jug√©es "trop puissantes" dans d'autres pays (surtout dans le cas de la cryptographie)
    ** Un exemple dans un autre monde que Java, la PS2 ne pouvait pas s'exporter partout car jug√©e trop puissante. +
    Jetez un oeil √† la section 4.2.4 de cet article pour plus d'infos : https://e.20-bal.com/law/18082/index.html
    ** D'o√π l'usage d'un *Security Provider* dans Java : https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/security/Provider.html

* *C'est √† nous d'indiquer √† notre serveur quels types de cl√©s, quels types de traitement il peut accepter*. Cela afin que le client ne puisse pas forcer un certificat que l'on n'accepte pas.

* Avec le Java 17, le *Security Manager* est maintenant *d√©pr√©ci√©*.
    ** Et devrait donc √™tre supprim√© d'ici peu

== 14h00 : Micronaut AOT pour optimiser vos applications pour le JIT et GraalVM

Talk donn√© par C√©dric Champeau

* Micronaut est un framework initialement cr√©√© pour les microservices, mais son utilisation a √©volu√© et est devenu plus g√©n√©raliste
* Le framework fait un max de choses au build time, en se servant de annotation processing

* Le constat est que *Spring* fait beaucoup de choses au *d√©marrage*, ce qui a un *co√ªt*
    ** Cela fonctionnait bien, MAIS n'√©tait pas adapt√© au Cloud (beaucoup de "stop" et "kill" puis de "red√©marrage"). Ce n'√©tait pas fluent du fait du temps pris au d√©marrage.
    ** Micronaut supprime les proxy qui sont si chers √† Spring
        *** et permet un d√©marrage avec une empreinte m√©moire tr√®s r√©duite

* GraalVM est une VM d√©velopp√©e par Oracle
    ** GraalVM permet de *g√©n√©rer du code natif* √† partir du code Java

* Micronaut : on va faire un max de choses au build, et √©liminer tout ce qui est r√©flexion et proxy, ce que n'aime PAS GraalVM.

Demo avec https://micronaut.io/launch

    * l'application peut √™tre d√©ploy√©e sur tous le Cloud

image:20220622_JavaDay_20.jpg[]

== 14h50 : De Maven 3 √† Maven 5

Talk donn√© par Herv√© Boutemy.

* Herv√© travaille chez Sonatype depuis 3 ans

.Maven 2
image:20220622_JavaDay_21.jpg[]

.Maven 3
image:20220622_JavaDay_22.jpg[]

.Aujourd'hui nous en sommes √† Maven 3.8
image:20220622_JavaDay_23.jpg[]

Et tout cela est toujours *bas√© sur le m√™me POM v4*.

    * Comme au d√©but de Maven 2.0...
    * A quelques diff√©rences pr√®s : 
        ** dependencyMangement import scope
        ** transitive dependency excludes (wildcard excludes)
        ** prerequisite (run time -> plugin only) vs enforcer (build time)
        ** properties : `${project.build.sourceEncoding}`, etc.

Et on ne peut pas le faire √©voluer CAR il est utilis√© par TOUT le monde.

.Le plan pour relancer les possibilit√©s d'√©volution de Maven
image:20220622_JavaDay_24.jpg[]

.Avec Maven 4, un POM *simplifi√©* va √™tre mis en place
image:20220622_JavaDay_25.jpg[]

* avec Maven 4, plus besoin d'indiquer la version de chaque sous-module, celle-ci est d√©duite du pom parent.

* Le *Maven wrapper* est directement issu du Gradle wrapper qui a √©t√© mis √† disposition en licence Apache
    ** `mvn wrapper:wrapper` -> on demande l'install du wrapper dans le projet
        *** ajout d'un r√©pertoire *wrapper* dans le projet, ainsi que les autres √©l√©ments du wrapper

* Autre fonctionnalit√© qui a √©t√© donn√© √† Maven, le *Maven Build Cache*
    ** cette fonctionnalit√© a √©t√© d√©velopp√© √† la base par Deutsch Bank
    ** on calcule l'empreinte du code de toutes les sources, et si aucune modification n'a √©t√© d√©tect√©e, on va utiliser le contenu du cache +
    image:20220622_JavaDay_26.jpg[]
    ** ce cache est par d√©faut cach√© dans le .m2
    ** Si cela vous int√©resse, *attendez la sortie de Maven 3.9*

* *Maven Daemon* (`mvnd`) : correspond √† une r√©flexion sur l'optimisation des build Maven
    ** permet des *build parall√®les* afin d'utiliser tous les coeurs de la machine
    ** plus de probl√®me du "mixte d'output" (qui rendait tr√®s compliqu√©e la lecture du build)

.En r√©sum√©
image:20220622_JavaDay_27.jpg[]

* Maven 3.9 pour l'√©t√© 2022
* Maven 4.0.0-alpha-1 pour Q3 2022
* Pour le Maven Build Cache, il faudra attendre la version 3.9

* Nouveau plugin *Buildplan*, h√©berg√© dans MojoHaus, permettant d'afficher le plan de build de Maven
    ** Plugin d√©velopp√© par Jean-Christophe Gay
    ** permet de comprendre comment les goals sont associ√©s √† vos ex√©cutions

[TIP]
====
Si l'on souhaite *participer au d√©veloppement communautaire de Maven*, contactez Herv√© !

Des Hackegarten sont organis√©s r√©guli√®rement (tous les mois ?) pour mettre le pied √† l'√©trier (voir si Twitter le Hack.Commit.Push https://twitter.com/hackcommitpush)
====

NOTE: Herv√© suite √† une question : OUI, on va avoir maven daemon AVEC le Maven Build Cache +
-> Et le r√©sultat est impressionant üòâ 

== 16h00 : R√©mi Forax : Valhalla: Vers de nouveaux generics universels et specialisables

.Si votre bo√Æte ne sait pas quoi faire de ses sous, parlez-lui de la taxe d'apprentissage
NOTE: *Taxe d'apprentissage*, ne pas h√©siter √† orienter vos bo√Ætes vers l'universit√© Gustave Eiffel

* R√©mi est ma√Ætre de conf ET d√©veloppeur Open Source pour le projet ASM
    ** ASM est le projet derri√®re TOUTTEEEEE la g√©n√©ration de bytecode c√¥t√© Java, et n'est maintenu que par 2 "pauvres fran√ßais" comme le dit R√©mi üòÖ 

Projet Valhalla (*Value classes*)

    * on en est au 4e proto
    * objectifs : 
        ** *abstraction for free* : no allocation of intermediary objects
        ** *Improve information density* : no header, use immediate value (no pointer) +
        image:20220622_JavaDay_28.jpg[]

Valhalla : *"je veux une classe pour d√©crire des types primitifs, MAIS je veux que ce soit une classe"*

    * et je ne veux PAS payer le co√ªt d'abstraction : o√π pour stocker juste un int, on se retrouve √† devoir g√©rer un header co√ªtant 32 bits + 64 bits (et en sachant qu'on va tout devoir aligner sur 64 bits du fait de l'architecture Intel)

En fait, on veut *manipuler des valeurs SANS pointeur*

    * donc, d√©j√†, je n'ai *pas de null*
    * mais perdre la notion de pointeurs, c'est perdre √©norm√©ment de choses (utiles) en Java

.flattening (applatissement des valeurs)
image:20220622_JavaDay_29.jpg[]

.2 types de value class
image:20220622_JavaDay_30.jpg[]

La machine virtuelle ne voit pas les classes param√©tr√©es (*erasure*), MAIS le compilateur les voit.

* notion de *SpecializationAnchor*

.regardons le bytecode
image:20220622_JavaDay_31.jpg[]
image:20220622_JavaDay_32.jpg[]

.Pour r√©sumer
image:20220622_JavaDay_33.jpg[]

-> C'est comme √ßa qu'il faudra √©crire le bytecode une fois qu'on aura la VM patch√©e...

image:20220622_JavaDay_34.jpg[]

.SpecializationAnchor object
image:20220622_JavaDay_35.jpg[]

.Pour r√©sumer "bis"
image:20220622_JavaDay_36.jpg[]

-> Talk m√©ritant d'√™tre repris tranquillement chez soi üòÖ 

== 16h50 : Panel de discussions avec les speakers

* R√©mi : c'est *extr√™mement bien d'avoir de la comp√©tition en termes d'impl√©mentation*
    ** R√©mi dit cela suite √† une question sur le nombre de projets en cours c√¥t√© JVM ET dans le "monde statique" (GraalVM qui fait un max de choses au build).
    ** En gros la question √©tait "Vers o√π va Java ? JVM ou statique ?"



